# v0.3.0 API 技术规格

> B4(Kling Provider) | B2(FFmpeg.wasm 拼接) | B5(ImageEditor) | B6(VideoAnalyzer)
>
> 源码版本：v0.3.0-dev | 2026-02-27

---

## 1. B4 — Kling REST API

### 1.1 认证

JWT 鉴权，客户端用 `access_key` + `secret_key` 本地签发。

```
算法: HS256
Payload: { "iss": <access_key>, "exp": <now+1800>, "nbf": <now-5> }
签名密钥: secret_key
```

请求头：`Authorization: Bearer <jwt_token>`。剩余有效期 < 2 分钟时自动重签。

### 1.2 创建视频任务

```
POST https://api.klingai.com/v1/videos/text2video
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| model_name | string | 是 | 固定 `"kling-v1"` |
| prompt | string | 是 | 生成提示词 |
| negative_prompt | string | 否 | 负面提示词 |
| cfg_scale | number | 否 | 0.0-1.0，默认 0.5 |
| mode | string | 否 | `"std"` / `"pro"` |
| aspect_ratio | string | 否 | `"16:9"` / `"9:16"` / `"1:1"` |
| duration | string | 否 | `"5"` / `"10"`（秒） |
| image | string | 否 | base64 图片，传入走图生视频 |

**Response**
```json
{ "code": 0, "data": { "task_id": "kling_abc123", "task_status": "submitted" } }
```

### 1.3 查询任务状态

```
GET https://api.klingai.com/v1/videos/text2video/{task_id}
```

```json
{
  "code": 0,
  "data": {
    "task_id": "kling_abc123",
    "task_status": "succeed",
    "task_status_msg": "",
    "created_at": 1740000000,
    "updated_at": 1740000120,
    "task_result": {
      "videos": [{ "id": "vid_001", "url": "https://cdn.klingai.com/videos/xxx.mp4", "duration": "5" }]
    }
  }
}
```

状态流转：`submitted` → `processing` → `succeed` | `failed`

### 1.4 错误码

| code | 含义 | 处理 |
|------|------|------|
| 1000 | 参数无效 | 检查请求体 |
| 1001 | 鉴权失败 | 重签 JWT |
| 1002 | 额度不足 | 提示充值 |
| 1003 | 频率限制（10 req/min） | 指数退避 |

### 1.5 轮询策略

首次等待 10s → 间隔 5s → 上限 300s → 超时返回 `{ status: 'timeout' }`。

对应 stub：`services/providers/kling.provider.ts:36`。

---

## 2. B2 — FFmpeg.wasm 视频拼接

依赖：`@ffmpeg/ffmpeg@^0.12.15` + `@ffmpeg/util@^0.12.2`。stub 位置：`components/VideoEditor.tsx:248`。

### 2.1 初始化

```typescript
import { FFmpeg } from '@ffmpeg/ffmpeg';
import { fetchFile, toBlobURL } from '@ffmpeg/util';

const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm';
const ffmpeg = new FFmpeg();
await ffmpeg.load({
  coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
  wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
});
```

### 2.2 拼接流程

```typescript
// 1. 写入片段
for (let i = 0; i < clips.length; i++)
  await ffmpeg.writeFile(`clip_${i}.mp4`, await fetchFile(clips[i].url));

// 2. 生成清单
await ffmpeg.writeFile('list.txt', clips.map((_, i) => `file 'clip_${i}.mp4'`).join('\n'));

// 3. 拼接（-c copy 不重编码）
await ffmpeg.exec(['-f', 'concat', '-safe', '0', '-i', 'list.txt', '-c', 'copy', 'output.mp4']);

// 4-5. 读取 → Blob URL
const data = await ffmpeg.readFile('output.mp4');
const url = URL.createObjectURL(new Blob([data], { type: 'video/mp4' }));
```

格式不一致时改用 `-c:v libx264 -c:a aac`（速度慢很多）。

### 2.3 进度回调

```typescript
ffmpeg.on('progress', ({ progress }) => setProgress(Math.round(progress * 100)));
```

### 2.4 Tauri 兼容性

| 问题 | 方案 |
|------|------|
| SharedArrayBuffer 不可用 | 用单线程 core（不加载 `.worker.js`） |
| CSP 拦截 WASM | Tauri 配置放行 `wasm-unsafe-eval` |
| 大文件 OOM（~2GB 限制） | 单片段 < 200MB，超限提示裁剪 |

---

## 3. B5 — ImageEditor API

stub 位置：`services/nodes/imageEditor.service.ts:61`（当前返回 `undefined`）。

### 3.1 上游函数签名

```typescript
// services/geminiServiceWithFallback.ts
export async function generateImageWithFallback(
  prompt: string,
  initialModel: string,
  inputs?: string[],       // 参考图（base64 或 URL）
  options?: any,
  context?: { nodeId?: string; nodeType?: string }
): Promise<string[]>       // 返回图片 URL 数组
```

### 3.2 调用实现

```typescript
private async editImage(sourceImage: string, prompt: string): Promise<string | undefined> {
  const { generateImageWithFallback } = await import('../geminiServiceWithFallback');
  const images = await generateImageWithFallback(
    `Edit this image: ${prompt}. Maintain the original style and composition.`,
    'gemini-2.0-flash',
    [sourceImage],
    { aspectRatio: 'auto' },
    { nodeId: this.nodeType, nodeType: 'IMAGE_EDITOR' }
  );
  return images?.[0];
}
```

### 3.3 约束

| 项目 | 规格 |
|------|------|
| sourceImage | base64 data URI 或 HTTPS URL |
| prompt | 建议 < 500 字符 |
| 返回值 | 取数组首元素，无结果返回空字符串 |
| 降级 | `generateImageWithFallback` 内部含模型降级，外层 catch 兜底 |

---

## 4. B6 — VideoAnalyzer API

stub 位置：`services/nodes/videoAnalyzer.service.ts:54`（当前返回硬编码字符串）。

### 4.1 输出类型

```typescript
interface AnalysisResult {
  sceneDescription: string;
  mood: string;
  pacing: 'slow' | 'medium' | 'fast';
  cameraWork: string[];    // 如 ["特写", "推镜头"]
  suggestions: string[];
}
```

### 4.2 调用实现

```typescript
import { GoogleGenAI } from '@google/genai';

private async analyzeVideo(videoUrl: string): Promise<string> {
  const ai = new GoogleGenAI({ apiKey: getApiKey() });
  const response = await ai.models.generateContent({
    model: 'gemini-2.0-flash',
    contents: [{
      parts: [
        { fileData: { mimeType: 'video/mp4', fileUri: videoUrl } },
        { text: '分析这段视频的场景、情绪、节奏和镜头语言，以 JSON 格式返回' }
      ]
    }]
  });
  return response.text ?? '';
}
```

`fileUri` 须为公网可达 URL 或 Gemini File API 上传后的 URI，本地 Blob URL 不可直接传入。

### 4.3 输入约束

| 项目 | 限制 |
|------|------|
| 格式 | MP4, MOV, WEBM |
| 时长 | < 1 小时 |
| 大小 | < 2GB |

### 4.4 响应解析

```typescript
function parseAnalysis(raw: string): AnalysisResult {
  try {
    return JSON.parse(raw.replace(/```json?\n?/g, '').replace(/```/g, '').trim());
  } catch {
    return { sceneDescription: raw, mood: '未识别', pacing: 'medium', cameraWork: [], suggestions: [] };
  }
}
```
