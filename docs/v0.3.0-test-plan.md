# v0.3.0 测试计划 — B10: CI + E2E

> 目标：从"手动跑测试"升级到"推代码自动拦截问题"，补齐 E2E 层，CI 全自动化。

## 1. 测试架构总览

```
Layer 4: CI 集成 (GitHub Actions)        ← 扩展现有 build-desktop.yml + 新增 test.yml
Layer 3: E2E 测试 (Playwright)           ← 全新搭建，覆盖核心用户路径
Layer 2: 组件测试 (Vitest + testing-lib)  ← 新增，验证 React 组件渲染逻辑
Layer 1: 单元测试 (Vitest)               ← 已有 87 个，继续扩展
```

现状快照：
- Vitest 4，6 个测试文件，87 个用例全部通过
- Playwright 未安装
- CI 仅覆盖桌面端构建（Windows + macOS），无自动化测试步骤

## 2. Playwright 搭建方案

### 2.1 安装

```bash
pnpm add -D @playwright/test
npx playwright install chromium
```

只装 Chromium——Tauri 桌面端用 WebView2/WebKit，Web 模式用 Chromium 覆盖即可，省掉 Firefox/WebKit 的 CI 时间。

### 2.2 配置 `playwright.config.ts`

```ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30_000,
  globalTimeout: 5 * 60_000,
  retries: process.env.CI ? 1 : 0,
  use: {
    baseURL: 'http://localhost:5173',
    screenshot: 'only-on-failure',
    trace: 'on-first-retry',
  },
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
    timeout: 30_000,
  },
  projects: [{ name: 'chromium', use: { browserName: 'chromium' } }],
});
```

### 2.3 目录结构

```
tests/
├── e2e/
│   ├── smoke.spec.ts             — 应用启动 + 基本渲染
│   ├── template-select.spec.ts   — 模板选择 + 工作流创建
│   ├── canvas-interact.spec.ts   — 节点拖拽 + 连线 + 缩放
│   ├── pipeline-run.spec.ts      — Template C 端到端执行
│   └── fixtures/
│       └── test-helpers.ts       — 公共定位器、等待函数
├── pipeline-e2e.test.ts          — 已有 (Vitest)
└── workflow-stress.test.ts       — 已有 (Vitest)
```

## 3. E2E 测试用例

### 3.1 冒烟测试 `smoke.spec.ts`（3 cases）

| # | 用例 | 断言 |
|---|------|------|
| 1 | 应用加载完成 | 欢迎页或画布容器可见，无 JS 报错 |
| 2 | 侧边栏节点面板可见 | `.node-panel` 存在且包含节点列表 |
| 3 | 设置面板可打开 | 点击设置按钮 → 设置弹窗/面板出现 |

### 3.2 模板选择 `template-select.spec.ts`（4 cases）

| # | 用例 | 断言 |
|---|------|------|
| 1 | 选择 Template A | 画布节点数匹配模板定义 |
| 2 | 选择 Template C | 5 个节点 + 4 条连线 |
| 3 | 创建空白工作流 | 画布无节点无连线 |
| 4 | 切换模板 | 旧节点全部清除，新模板节点加载 |

### 3.3 画布交互 `canvas-interact.spec.ts`（5 cases）

| # | 用例 | 断言 |
|---|------|------|
| 1 | 拖拽节点 | `transform` 坐标变化 |
| 2 | 端口连线 | 输出→输入拖拽后，edge 元素 +1 |
| 3 | 滚轮缩放 | viewport scale 值变化 |
| 4 | 框选多节点 | 选中节点数 ≥ 2 |
| 5 | 删除连线 | 选中 edge → Delete 键 → edge 消失 |

### 3.4 管线执行 `pipeline-run.spec.ts`（3 cases）

| # | 用例 | 断言 |
|---|------|------|
| 1 | 点击运行 | 节点依次出现 `running` 状态样式 |
| 2 | 全部完成 | 所有节点显示 `success` 状态 |
| 3 | 中途失败 | 失败节点显示 `error` + 错误气泡可见 |

## 4. CI 集成方案

### 4.1 新增 `.github/workflows/test.yml`

```yaml
name: Test
on: [push, pull_request]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: pnpm install
      - run: pnpm test

  e2e-test:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: pnpm install
      - run: npx playwright install --with-deps chromium
      - run: pnpm build
      - run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
```

E2E 依赖单元测试通过（`needs: unit-test`），单元挂了就不跑 E2E，省 CI 资源。

### 4.2 修改 `build-desktop.yml`

在现有构建步骤前插入测试门禁：

```yaml
# 在 build 步骤之前添加
- name: Run tests
  run: pnpm test
# 测试失败 → 整个 job 失败 → 构建不会执行
```

## 5. 覆盖率目标

| 层级 | 当前 | v0.3.0 目标 | 差距 |
|------|------|------------|------|
| 单元测试 | 87 tests | ≥ 100 tests | +13 |
| 组件测试 | 0 | ≥ 10 tests | +10 |
| E2E 测试 | 0 | ≥ 15 tests | +15 |
| CI 通过率 | 手动 | 100% 自动化 | — |

## 6. 验收标准

- [ ] `pnpm test` 全绿（单元 + 组件）
- [ ] `npx playwright test` 全绿（E2E，15+ 用例）
- [ ] push / PR 自动触发 `test.yml`，两套测试串行执行
- [ ] 测试失败时自动上传 Playwright report artifact
- [ ] `build-desktop.yml` 测试失败时阻止构建
- [ ] 本地 `pnpm test && npx playwright test` 一条命令跑完全部
